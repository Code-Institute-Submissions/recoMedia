{% extends 'base.html' %}
{% block content %}

<h2>Welcome {{username}}</h2>

<h3>Your Films</h3>

{% for film in films %}

    <h4>{{film.title}}</h4>

    <ul>
        <li>{{film.release_date}}</li>
        <li>Director:{{film.director}}</li>
    {% for rate in film.ratings %}
    {% if rate.username==username %}        
        <li>Rating: {{rate.rating}}</li>
        <li>Review: {{rate.review}}</li>
    {% endif %}
    {% endfor %}
    </ul>
{% endfor %}

<h3>Rate your first film now.</h3>

<form action="{{url_for('insert_rating', username='{{username}}' ) }}" method="POST" class="col s12">
	{% with messages = get_flashed_messages(with_categories=true) %}
	{% if messages %}
	<ul class=flashes>
		{% for category, message in messages %}
		<div class="{{category}}">{{ message }}</div>
		{% endfor %}
	</ul>
	{% endif %}
	{% endwith %}
	<div class="row">     
		<div class="input-field col s6">
			<input id="film_title" type="text" name="film_title" class="validate autocomplete" onblur="getFilms(this)" onkeyup="getSuggestions(this)" /required> <!-- onkeyup="getSuggestions(this)" -->
			<label for="film_title" class="active">Film title</label>
		</div>
        <div class="row col s6" id="film-display">
            <!--<div class="film-data" id="title1"></div>
            <div class="film-data" id="title2"></div>
            <div class="film-data" id="title3"></div>-->
        </div>
	</div>
	<div class="row">
		<div class="input-field col s12">
            <select id="years" name='years' onblur="getFilm(this)" /required>
                <option value="" disabled selected>Choose which year</option>              
            </select>
			<label>Year</label>
		</div>
	</div>
	<div class="row">
		<div class="input-field col s12">
            <select id="ratings" /required>
                <option value="" disabled selected>Give a rating</option>
                <option value="0">0</option>  
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>  
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>          
            </select>
			<label>Rating</label>
			<!--<input id="rating" type="number" name="rating" class="validate" oninput="check(this)" /required>
			<label for="rating" class="active">Rating</label>-->
		</div>
	</div>
	<div class="row">
		<div class="input-field col s12">
			<textarea id="review" name="review" class="materialize-textarea" /required></textarea>
			<label for="review">Review</label>
		</div>
	</div>
	<div class="row" id="err-msg">
	</div>
	<button class="btn waves-effect waves-light" type="submit" name="action">Create Rating
        <i class="material-icons right"></i>
    </button>
</form>

<script language='javascript' type='text/javascript'>
    var omdb_data;
   // var film_options;
    var elems;
    var instances;
    var currYear = (new Date()).getFullYear();

    $(document).ready(function(){
        //$('select').formSelect();
        elems = document.querySelectorAll('select');
        /*$('.datepicker').datepicker({
			defaultDate: new Date(2000,0,01),
			maxDate: new Date(),
			yearRange: [1928, currYear],
			format: "yyyy/mm/dd"
        });*/
        $('#years').on('change', function() {
            console.log('click registered.')
            console.log($(this).val())
            let year=$(this).val();
            getFilm(year);
        });
        /*$('select').blur( function(){
            getFilm(this);
        });*/
    });

    function getSuggestions(filmname){
        $.get('https://www.omdbapi.com/?s='+filmname.value+'&apikey=61e49492',function(rawdata){
            console.log('getSuggestions entered.')
            /**** clear previous suggestions ****/
            var title_object = {};
            /**** autocomplete film suggestions ****/
            for (film of rawdata.Search){
                title_object[film.Title] = null;
            }

            $('input.autocomplete').autocomplete({
                data: title_object,
                limit: 5
            });  
        }); 
    }  
           
	function getFilms(filmname){
	    $.get('https://www.omdbapi.com/?s='+filmname.value+'&apikey=61e49492',function(rawdata){
            //var elems = document.querySelectorAll('select');
            //var rawstring=JSON.stringify(rawdata);
            //var rawstring=JSON.stringify(rawdata);
            //omdb_data = JSON.parse(rawstring)
            //var imdburl="https://www.imdb.com/title/"+omdb_data.Search[0].imdbID+"/";

            /**** clear previous search data ****/
            $("#film-display").html("");
            //$(".film-data").html("");
            $('#years').html(`<option value="" disabled selected>Choose which year</option>`);
            var year_object = {};
	        var arrayNoDuplicatesID = [];
	        var id = 0;
	        for ( film of rawdata.Search){
	            if (filmname.value.toLowerCase()===film.Title.toLowerCase() && arrayNoDuplicatesID.indexOf(film.imdbID)===-1 ){
	                console.log("condition accessed.")
                    year_object[film.Year] = null;
                    id++;
                    $("#film-display").append(`<div class="film-data" id="title`+id+`"><img src="`+film.Poster+`"/><p>"`+film.Title+`", `+film.Year+`</p></div>`);
                    arrayNoDuplicatesID.push(film.imdbID);
                    $('#years').append(`<option id="year`+id+`" value="`+film.Year+`" onclick="getFilm(this)">`+film.Year+`</option>`)
                }
            }
            console.log('id is: '+id)
            if (id===0){
                $("#film-display").html("<p>Unfortunately this film doesn't exist in our database.</p>")
            }
	        instances = M.FormSelect.init(elems, year_object);
	    });
    }

    function getFilm(year) {
        console.log('getFilm accessed.')
        let film_title=$('#film_title').val();
	    $.get('https://www.omdbapi.com/?s='+film_title+'&apikey=61e49492',function(rawdata){
            $("#film-display").html("");
            let arrayNoDuplicatesID=[];
            for (film of rawdata.Search){
                console.log('film_title is '+film_title+' and film.Title is '+film.Title)
                console.log('year is '+year+' & film.Year is '+film.Year)
                if (film_title.toLowerCase()===film.Title.toLowerCase() && arrayNoDuplicatesID.indexOf(film.imdbID)===-1 && year===film.Year ){
                        $("#film-display").html(`<div class="film-data" id="title1"><img src="`+film.Poster+`"/><p>"`+film.Title+`", `+film.Year+`</p></div>`);
                        arrayNoDuplicatesID.push(film.imdbID);
                }
            }

        });
    }
</script>

{% endblock %}