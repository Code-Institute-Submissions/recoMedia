{% extends 'base.html' %}
{% block content %}

<h2>Welcome {{username}}</h2>

<h3>Your Films</h3>
{% set film_count = films|length %}
{% if film_count > 0 %}

<p>You have rated {{ film_count }} films</p>

<div class="carousel-container">
    <div class="prev hide-on-med-and-down"><</div>
    <div class="carousel carousel-slider center" data-indicators="false">
    {% for film in films %}
        <div class="carousel-item center">
            <div class="arrow-pic-container">
                <div class="prev hide-on-large-and-up"><</div>
                <div class="poster-container">
                    <img src="{{film.poster}}" alt="{{film.title}} (poster unavailable)">
                {% for rate in film.ratings %}
                {% if rate.username==username %} 
                    <div class="rating-overlay">
                        <div class="rating-container">
                            {{rate.rating}}
                        </div>
                    </div>
                </div>
                <div class="next hide-on-large-and-up">></div>
            </div>
            <div class="table-container">
                <table>
                    <tr>
                        <td class="left-field ">Year:</td><td class="right-field">{{film.year}}</td>
                    </tr>
                    <tr>
                        <td class="left-field ">Cast:</td><td class="right-field">{{film.cast}}</td>
                    </tr>
                    <tr>
                        <td class="left-field">Director:</td><td class="right-field">{{film.director}}</td>
                    </tr>
                    <tr>
                        <td class="left-field">Runtime:</td><td class="right-field">{{film.runtime}}</td>    
                    </tr>
                    <tr>
                        <td class="left-field">Review:</td><td class="right-field">{{rate.review}}</td>    
                    </tr>
                </table>
            </div>
            {% endif %}
            {% endfor %}
        
        </div>
    
    {% endfor %}
    </div>
    <div class="next hide-on-med-and-down">></div>
</div>

<h3>Your Top Picks</h3>

<ul class="pagination top-picks">
    <li class="disabled left-chev" onclick="prevPage(this)"><a href="#!"><i class="material-icons">chevron_left</i></a></li>
    {% for page in range(top_picks|count) %}
    {% if page +1==1 %}
    <li class="active" id="tp-page-btn{{page+1}}" class="page-btn" onclick="goToPage(this)">
    {% else %}
    <li id="tp-page-btn{{page+1}}" class="page-btn" onclick="goToPage(this)">
    {% endif %}
    <a href="#tp-page-{{page+1}}">{{page+1}}</a></li>
    {% endfor %}
    <li class="waves-effect right-chev" onclick="nextPage(this)"><a href="#!"><i class="material-icons">chevron_right</i></a></li>
</ul>

<!-- Modal Trigger -->
 <!-- <a class="waves-effect waves-light btn modal-trigger" href="#modal1">Modal Test</a> -->

  <!-- Modal Structure -->
  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Confirmation Delete</h4>
      <p id="del-msg"></p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Keep</a>
      <a href="" id="del-btn" class="modal-close btn-flat">Delete</a>
    </div>
  </div>
          

{% set pages_counted = [] %}
{% for page in top_picks %}
<div id="tp-page-{{loop.index}}" class="film-card-container top-picks">
<div class="table">
{% for film in page %}
    <div class="table-row film-card">
        <div class="table-cell rank">{{ loop.index + (pages_counted|length*films_per_page) }}</div>
        <a class="table-cell title" id="title-{{film.imdbID}}" href="{{ url_for('get_reviews', filmID=film.imdbID, avgRating=film.averageRating) }}">
        {{film.title}}</a>
        <div class="table-cell year" id="year-{{film.imdbID}}" >{{film.year}}</div>
        <div class="table-cell rating">{{film.ratings.0.rating}}</div>  
        <div class="table-cell delete-rating" id="del-{{film.imdbID}}" onclick="confirmDelete(this)"><span class="material-icons">delete</span></div>  
    </div>
{% endfor %}
</div>
</div>
{% set __ = pages_counted.append(1) %}
{% endfor %}

<h3>Add a rating to your collection.</h3>
{% else %}
<p>You don't currently have any film reviews.</p>

<h3>Rate your first film now.</h3>
{% endif %}
<p>If adding a review for a previously added film. The latest review will overwrite the pre-existing one.</p>

<form action="{{url_for('insert_rating', username='{{username}}' ) }}" method="POST" class="col s12">
	{% with messages = get_flashed_messages(with_categories=true) %}
	{% if messages %}
	<ul class=flashes>
		{% for category, message in messages %}
		<div class="{{category}}">{{ message }}</div>
		{% endfor %}
	</ul>
	{% endif %}
	{% endwith %}
	<div class="row">     
		<div class="input-field col s6">
            
			<input id="film_title" type="text" name="film_title" class="validate autocomplete" onblur="getFilms(this)" onkeyup="getSuggestions(this)" /required>
			<label for="film_title" class="active"><span class="material-icons">search</span>Film title</label>
		</div>
        <div class="row col s6" id="film-display">
        </div>
	</div>
    <div class="row">
		<div class="input-field col s12">
            <select id="imdbID" name="imdbID" required>
                <option value="" disabled selected>Imdb ID</option>              
            </select>
			<label>Imdb ID</label>
		</div>
	</div>
	<div class="row">
		<div class="input-field col s12">
            <select id="Year" name="Year" onblur="getFilm(this)" required>
                <option value="" disabled selected>Choose which year</option>              
            </select>
			<label>Year</label>
		</div>
	</div>
        <div class="row">     
		<div class="input-field col s6">
            <select id="Director" name="Director" required>
                             
            </select>
			<label>Director</label>
		</div>
    </div>
    <div class="row">     
		<div class="input-field col s6">
			<select id="Actors" name="Actors" required>
                             
            </select>
			<label>Cast</label>
		</div>
    </div>
    <div class="row">
		<div class="input-field col s3">
            <select id="Runtime" name="Runtime" required>
                <option value="" disabled selected>Runtime</option>              
            </select>
			<label>Runtime</label>
		</div>
	</div>
	<div class="row">
		<div class="input-field col s12">
            <select id="rating" name="rating" required>
                <option value="" disabled selected>Give a rating</option>
                <option value="0">0</option>  
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>  
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>          
            </select>
			<label>Rating</label>
			<!--<input id="rating" type="number" name="rating" class="validate" oninput="check(this)" /required>
			<label for="rating" class="active">Rating</label>-->
		</div>
	</div>
	<div class="row">
		<div class="input-field col s12">
			<textarea id="review" name="review" maxlength="500" class="materialize-textarea" required></textarea>
			<label for="review">Review<br></label>
		</div>
        <span>Please note the review is limited to 500 characters.</span>
	</div>

	<div class="row" id="err-msg">
	</div>
	<button class="btn form-submit" type="submit" name="action">Create Rating
        <i class="material-icons right"></i>
    </button>
</form>

{% if film_count > 0 %}
    Remove a rating
{% endif %}

<script language='javascript' type='text/javascript'>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
   // var film_options;
    var elems;
    var instances;
    var currYear = (new Date()).getFullYear();

    $(document).ready(function(){
        //$('select').formSelect();
        elems = document.querySelectorAll('select');
        $('#years').on('change', function() {
            console.log('change registered.')
            console.log($(this).val())
            let year=$(this).val();
            getFilm(year);
        });
        $('.carousel.carousel-slider').carousel({
            fullWidth: true,
        });
        $('.prev').click(function(){
            $('.carousel').carousel('prev');
        });
        $('.next').click(function(){
            $('.carousel').carousel('next');
        });
        $('.modal').modal();
    });

    function getSuggestions(filmname){
        $.get('https://www.omdbapi.com/?s='+filmname.value+'&apikey=61e49492',function(rawdata){
            console.log('getSuggestions entered.')
            /**** clear previous suggestions ****/
            var title_object = {};
            /**** autocomplete film suggestions ****/
            for (film of rawdata.Search){
                title_object[film.Title] = null;
            }

            $('input.autocomplete').autocomplete({
                data: title_object,
                limit: 5
            });  
        }); 
    }  
           
	function getFilms(filmname){
	    $.get('https://www.omdbapi.com/?s='+filmname.value+'&apikey=61e49492',function(rawdata){
            /**** clear previous search data ****/
            $("#film-display").html("");
            $('#years').html(`<option value="" disabled selected>Choose which year</option>`);
            $('#imdbID').html(`<option value="" disabled selected>Imdb ID</option>`);
            var year_object = {};
	        var arrayNoDuplicatesID = [];
	        var id = 0;
	        for ( film of rawdata.Search){
	            if (filmname.value.toLowerCase()===film.Title.toLowerCase() && arrayNoDuplicatesID.indexOf(film.imdbID)===-1 && film.Type==='movie'){
	                console.log("condition accessed.")
                    year_object[film.Year] = null;
                    id++;
                    $("#film-display").append(`<div class="film-data" id="`+film.imdbID+`"><img src="`+film.Poster+`"/><p>"`+film.Title+`", `+film.Year+`, `+film.imdbID+`</p></div>`);
                    arrayNoDuplicatesID.push(film.imdbID);
                    }
            }
            if (id===0){
                $("#film-display").html("<p>Unfortunately this film doesn't exist in our database.</p>")
            }
            
             $('#film-display > div').on('click', function() {
                console.log('click registered.')
                //console.log($(this).id)
                console.log('id is '+this.id)
                getFilm(this.id);
            });
	    });
    }

    function getFilm(chosen_id) {
        console.log('getFilm accessed.')
        let film_title=$('#film_title').val();
        $('select').formSelect();
	    $.get('https://www.omdbapi.com/?i='+chosen_id+'&apikey=61e49492',function(rawdata){
            //$("#film-display").html("");
            let arrayNoDuplicatesID=[];
            var rawstring=JSON.stringify(rawdata);
            omdb_data = JSON.parse(rawstring)
            console.log('rawstring is ' +rawstring+', Actors = '+rawdata["Actors"]+' Director = '+rawdata["Director"]+' runtime= '+rawdata["Runtime"])           
                
                if (arrayNoDuplicatesID.indexOf(rawdata["imdbID"])===-1){
                        //$("#film-display").html(`<div class="film-data" id="title1"><img src="`+film.Poster+`"/><p>"`+film.Title+`", `+film.Year+`, `+film.imdbID+`</p></div>`);
                    let fields=["imdbID","Year","Director","Actors","Runtime"];
                    for ( f of fields)
                        createElem(f, chosen_id);
                        arrayNoDuplicatesID.push(film.imdbID);
                }

        });
    }
    function createElem(parentNode, film_id) {
        $.get('https://www.omdbapi.com/?i='+film_id+'&apikey=61e49492',function(rawdata){
            console.log(parentNode)
            $("#"+parentNode).empty();
            let option=document.createElement("OPTION");
            let att = document.createAttribute("value");       // Create a "class" attribute
            att.value = rawdata[parentNode];                           // Set the value of the class attribute
            option.setAttributeNode(att);                  
            //option.attr({value: rawdata[parentNode], disabled: "disabled", selected: "selected");
            console.log(parentNode+' is '+option.value)
            option.innerHTML=rawdata[parentNode];
            document.getElementById(parentNode).appendChild(option);
        });
    }
    function confirmDelete(film){
        let filmId=film.id.slice(4);
        let filmTitle=$('#title-'+filmId).text();
        let filmYear=$('#year-'+filmId).text();
        $('#del-msg').html("Delete review for "+filmTitle+" ("+filmYear+") ?");
        $('#modal1').modal('open');
        $('#del-btn').attr("href", $SCRIPT_ROOT+'/delete_rating/'+filmId); 
    }
</script>

{% endblock %}